name: Create GitHub Release on Branch Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - staging

jobs:
  release-and-publish:
    # Run this job if the PR was merged to either main or staging
    if: |
      github.event.pull_request.merged == true && 
      (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'staging')
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for go-semantic-release to create tags and releases
      packages: write # If you use GitHub Packages for Docker images (good to have)
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          # Fetch all history so go-semantic-release can determine the version based on all commits
          fetch-depth: 0
          # We need to check out the target branch itself after the merge, not the PR ref
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Setup Go environment
        uses: actions/setup-go@v4
        with:
          go-version: '1.24' # Updated to match project's Go version

      # Optional: Add linting and testing steps here if you want to be absolutely sure
      # before a release, though these should ideally be covered by PR checks.
      # - name: Run Go linter
      #   uses: golangci/golangci-lint-action@v3
      #   with:
      #     version: latest
      # - name: Run Go tests
      #   run: go test -v ./...

      - name: Run semantic versioning and create release
        id: semantic-release
        uses: go-semantic-release/action@v1
        with:
          prerelease: true  # Always create a pre-release
          hooks: goreleaser
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
